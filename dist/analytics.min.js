let accountID,appName,userID,sessionID,postIntervalSeconds,granularitySec,postURL;const DEFAULT_GRANULARITY_IN_SECONDS=3,DEFAULT_RETRY_TIME_IN_SECONDS=30,DEFAULT_POST_INTERVAL_SECONDS=600,USERID_LOCAL_STORAGE_KEY="aicore.analytics.userID",POST_LARGE_DATA_THRESHOLD_BYTES=1e4;let currentAnalyticsEvent=null;const IS_NODE_ENV="undefined"==typeof window;let DEFAULT_BASE_URL="https://analytics.core.ai",granularityTimer,postTimer,currentQuantisedTime=0;if(IS_NODE_ENV)throw new Error("Node environment is not currently supported");function _createAnalyticsEvent(){return{schemaVersion:1,accountID:accountID,appName:appName,uuid:userID,sessionID:sessionID,granularitySec:granularitySec,unixTimestampUTC:+new Date,numEventsTotal:0,events:{}}}function _validateCurrentState(){if(!currentAnalyticsEvent)throw new Error("Please call initSession before using any analytics event")}function getCurrentAnalyticsEvent(){return _validateCurrentState(),JSON.parse(JSON.stringify(currentAnalyticsEvent))}function _getOrCreateUserID(){let t=localStorage.getItem(USERID_LOCAL_STORAGE_KEY);return t||(t=crypto.randomUUID(),localStorage.setItem(USERID_LOCAL_STORAGE_KEY,t)),t}function _getOrCreateSessionID(){let t=sessionStorage.getItem(USERID_LOCAL_STORAGE_KEY);return t||(t=Math.random().toString(36).substr(2,10),sessionStorage.setItem(USERID_LOCAL_STORAGE_KEY,t)),t}function _setupIDs(){userID=_getOrCreateUserID(),sessionID=_getOrCreateSessionID()}function _retryPost(t){t.backoffCount=(t.backoffCount||0)+1,console.log(`Failed to call core analytics server. Will retry in ${DEFAULT_RETRY_TIME_IN_SECONDS*t.backoffCount}s: `),setTimeout(()=>{_postCurrentAnalyticsEvent(t)},1e3*DEFAULT_RETRY_TIME_IN_SECONDS*t.backoffCount)}function _postCurrentAnalyticsEvent(e){var t;e||(e=currentAnalyticsEvent,currentAnalyticsEvent=_createAnalyticsEvent()),0!==e.numEventsTotal&&((t=JSON.stringify(e)).length>POST_LARGE_DATA_THRESHOLD_BYTES&&console.warn(`Analytics event generated is very large at greater than ${t.length}B. This 
        typically means that you may be sending too many value events? .`),window.fetch(postURL,{method:"POST",headers:{"Content-Type":"application/json"},body:t}).then(t=>{200!==t.status&&(400!==t.status?_retryPost(e):console.error("Bad Request, this is most likely a problem with the library, update to latest version."))}).catch(t=>{console.error(t),_retryPost(e)}))}function _setupTimers(){granularityTimer&&(clearInterval(granularityTimer),granularityTimer=null),granularityTimer=setInterval(()=>{currentQuantisedTime+=granularitySec},1e3*granularitySec),postTimer&&(clearInterval(postTimer),postTimer=null),postTimer=setInterval(_postCurrentAnalyticsEvent,1e3*postIntervalSeconds)}function initSession(t,e,n,r,a){if(!t||!e)throw new Error("accountID and appName must exist for init");accountID=t,appName=e,postIntervalSeconds=n||DEFAULT_POST_INTERVAL_SECONDS,granularitySec=r||DEFAULT_GRANULARITY_IN_SECONDS,postURL=(a||DEFAULT_BASE_URL)+"/ingest",_setupIDs(),currentAnalyticsEvent=_createAnalyticsEvent(),_setupTimers()}function _ensureAnalyticsEventExists(t,e,n){let r=currentAnalyticsEvent.events;r[t]=r[t]||{},r[t][e]=r[t][e]||{},r[t][e][n]=r[t][e][n]||{time:[],valueCount:[]}}function _validateEvent(t,e,n,r,a){if(_validateCurrentState(),!t||!e||!n)throw new Error("missing eventType or category or subCategory");if("number"!=typeof r||r<0)throw new Error("invalid count");if("number"!=typeof a)throw new Error("invalid value")}function _updateExistingAnalyticsEvent(e,n,r,a,s,i){let o=currentAnalyticsEvent.events;var t="number"==typeof o[n][r][a].valueCount[e];if(t&&0===i)o[n][r][a].valueCount[e]+=s;else if(t&&0!==i){let t={};t[i]=s,t[0]=o[n][r][a].valueCount[e],o[n][r][a].valueCount[e]=t}else if(!t){let t=o[n][r][a].valueCount[e];t[i]=(t[i]||0)+s}currentAnalyticsEvent.numEventsTotal+=1}function analyticsEvent(e,n,r,a=1,s=0){_validateEvent(e,n,r,a,s),_ensureAnalyticsEventExists(e,n,r);let i=currentAnalyticsEvent.events;var t=i[e][n][r].time;if((0<t.length?t[t.length-1]:null)===currentQuantisedTime)_updateExistingAnalyticsEvent(i[e][n][r].valueCount.length-1,e,n,r,a,s);else{if(i[e][n][r].time.push(currentQuantisedTime),0===s)i[e][n][r].valueCount.push(a);else{let t={};t[s]=a,i[e][n][r].valueCount.push(t)}currentAnalyticsEvent.numEventsTotal+=1}}export{initSession,getCurrentAnalyticsEvent,analyticsEvent};
//# sourceMappingURL=analytics.min.js.map